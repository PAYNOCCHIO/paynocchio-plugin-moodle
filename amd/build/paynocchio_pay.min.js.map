{"version":3,"file":"paynocchio_pay.min.js","sources":["../src/paynocchio_pay.js"],"sourcesContent":["// This file is part of the Paynocchio payments module for Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\nimport {makePayment} from \"./repository\";\r\nimport {exception as displayException} from 'core/notification';\r\nimport Templates from 'core/templates';\r\n\r\n/**\r\n * Paynocchio repository module to encapsulate all of the AJAX requests that can be sent for bank.\r\n *\r\n * @module     paygw_paynocchio/repository\r\n * @copyright  2024 Paynocchio <ceo@paynocchio.com>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nconst checkPayability = (value, fullAmount, balance = '0', element) => {\r\n    if(parseFloat(value)+parseFloat(balance) < parseFloat(fullAmount)) {\r\n        element.classList.add('disabled');\r\n        document.getElementById('topup_message').innerText = 'Please top up or use your Bonuses.';\r\n        document.getElementById('topup_message').classList.remove('paynocchio-hidden');\r\n    } else {\r\n        element.classList.remove('disabled');\r\n        document.getElementById('topup_message').innerText = '';\r\n        document.getElementById('topup_message').classList.add('paynocchio-hidden');\r\n        document.getElementById('paynocchio_gaining_bonuses').classList.remove('paynocchio-hidden');\r\n    }\r\n};\r\n\r\nconst changePayButtonValues = (fullAmount, bonuses) => {\r\n    const current_amount = document.getElementById('current_amount');\r\n    const old_amount = document.getElementById('old_amount');\r\n    const discount = document.getElementById('discount');\r\n    let old_amount_value = fullAmount;\r\n    if (bonuses != 0) {\r\n        current_amount.innerText = (old_amount_value - bonuses);\r\n        old_amount.innerText = \"$\" + old_amount_value;\r\n        discount.innerText = '-' + ((bonuses * 100) / old_amount_value).toFixed(2) + '%';\r\n        old_amount.classList.remove('paynocchio-hidden');\r\n        discount.classList.remove('paynocchio-hidden');\r\n    } else {\r\n        current_amount.innerText = old_amount_value;\r\n        old_amount.classList.add('paynocchio-hidden');\r\n        discount.classList.add('paynocchio-hidden');\r\n    }\r\n};\r\n\r\nconst changeBonusesValue = (balance, bonuses) => {\r\n    const element = document.getElementById('bonuses_to_get');\r\n    element.innerText = ((balance - bonuses) * 0.1).toFixed(2).slice(0, -1);\r\n};\r\n\r\nexport const init = (component, paymentArea, itemid, fullAmount, balance, bonuses_conversion_rate) => {\r\n\r\n    const paynocchio_pay_button = document.getElementById('paynocchio_pay_button');\r\n\r\n    if (paynocchio_pay_button) {\r\n\r\n        const range = document.getElementById('bonuses-range');\r\n        const input = document.getElementById('bonuses-value');\r\n\r\n        let bonuses = 0;\r\n        if(input) {\r\n            bonuses = parseFloat(input.value) * parseFloat(bonuses_conversion_rate);\r\n        }\r\n\r\n        if(range && input) {\r\n            checkPayability(bonuses, fullAmount, balance, paynocchio_pay_button);\r\n\r\n            input.addEventListener('change', () => {\r\n                range.value = bonuses;\r\n            });\r\n            range.addEventListener('change', () => {\r\n                bonuses = range.value;\r\n                input.value = range.value;\r\n                checkPayability(bonuses, fullAmount, balance, paynocchio_pay_button);\r\n                changeBonusesValue(fullAmount, bonuses);\r\n                changePayButtonValues(fullAmount, bonuses);\r\n            });\r\n            range.addEventListener('input', () => {\r\n                bonuses = range.value;\r\n                input.value = range.value;\r\n                checkPayability(bonuses, fullAmount, balance, paynocchio_pay_button);\r\n                changeBonusesValue(fullAmount, bonuses);\r\n                changePayButtonValues(fullAmount, bonuses);\r\n            });\r\n        } else {\r\n            checkPayability(0, fullAmount, balance, paynocchio_pay_button);\r\n        }\r\n\r\n        paynocchio_pay_button.addEventListener('click', () => {\r\n\r\n            const spinner = document.querySelector('.paynocchio-spinner');\r\n            const topup_message = document.getElementById('topup_message');\r\n\r\n            if(bonuses + balance < fullAmount) {\r\n                topup_message.innerText = 'Sorry, but no';\r\n                return;\r\n            }\r\n\r\n            paynocchio_pay_button.classList.add('disabled');\r\n\r\n            spinner.classList.add('active');\r\n            makePayment(component, paymentArea, itemid, fullAmount, bonuses)\r\n                .then(data => {\r\n                    if(data.success) {\r\n                        spinner.classList.remove('active');\r\n                        topup_message.innerText = 'Success';\r\n                        window.location.reload();\r\n                        Templates.renderForPromise('paygw_paynocchio/enrolled_already', [])\r\n                            .then(({html, js}) => {\r\n                                Templates.replaceNodeContents('.paynocchio-profile-block', html, js);\r\n                            })\r\n                            .catch((error) => displayException(error));\r\n                    } else {\r\n                        topup_message.innerText = 'There is an Error occurred. Please try again later.';\r\n                        paynocchio_pay_button.classList.remove('disabled');\r\n                    }\r\n                });\r\n        });\r\n    }\r\n};\r\n"],"names":["obj","_templates","__esModule","default","checkPayability","value","fullAmount","balance","arguments","length","undefined","element","parseFloat","classList","add","document","getElementById","innerText","remove","changePayButtonValues","bonuses","current_amount","old_amount","discount","old_amount_value","toFixed","changeBonusesValue","slice","_exports","init","component","paymentArea","itemid","bonuses_conversion_rate","paynocchio_pay_button","range","input","addEventListener","spinner","querySelector","topup_message","makePayment","then","data","success","window","location","reload","Templates","renderForPromise","_ref","html","js","replaceNodeContents","catch","error","displayException"],"mappings":"kKAiBuC,IAAAA;;;;;;;kFAAvCC,YAAuCD,IAAvCC,aAAuCD,IAAAE,WAAAF,KAAAG,QAAAH,KAUvC,MAAMI,gBAAkB,SAACC,MAAOC,YAAuC,IAA3BC,QAAOC,UAAAC,eAAAC,IAAAF,aAAAA,aAAG,IAAKG,QAAOH,UAAAC,SAAAD,kBAAAE,EAC3DE,WAAWP,OAAOO,WAAWL,SAAWK,WAAWN,aAClDK,QAAQE,UAAUC,IAAI,YACtBC,SAASC,eAAe,iBAAiBC,UAAY,qCACrDF,SAASC,eAAe,iBAAiBH,UAAUK,OAAO,uBAE1DP,QAAQE,UAAUK,OAAO,YACzBH,SAASC,eAAe,iBAAiBC,UAAY,GACrDF,SAASC,eAAe,iBAAiBH,UAAUC,IAAI,qBACvDC,SAASC,eAAe,8BAA8BH,UAAUK,OAAO,uBAIzEC,sBAAwBA,CAACb,WAAYc,WACvC,MAAMC,eAAiBN,SAASC,eAAe,kBACzCM,WAAaP,SAASC,eAAe,cACrCO,SAAWR,SAASC,eAAe,YACzC,IAAIQ,iBAAmBlB,WACR,GAAXc,SACAC,eAAeJ,UAAaO,iBAAmBJ,QAC/CE,WAAWL,UAAY,IAAMO,iBAC7BD,SAASN,UAAY,KAAkB,IAAVG,QAAiBI,kBAAkBC,QAAQ,GAAK,IAC7EH,WAAWT,UAAUK,OAAO,qBAC5BK,SAASV,UAAUK,OAAO,uBAE1BG,eAAeJ,UAAYO,iBAC3BF,WAAWT,UAAUC,IAAI,qBACzBS,SAASV,UAAUC,IAAI,uBAIzBY,mBAAqBA,CAACnB,QAASa,WACjBL,SAASC,eAAe,kBAChCC,WAAmC,IAArBV,QAAUa,UAAgBK,QAAQ,GAAGE,MAAM,GAAI,EAAE,EAwEzEC,SAAAC,KArEkBA,CAACC,UAAWC,YAAaC,OAAQ1B,WAAYC,QAAS0B,2BAEtE,MAAMC,sBAAwBnB,SAASC,eAAe,yBAEtD,GAAIkB,sBAAuB,CAEvB,MAAMC,MAAQpB,SAASC,eAAe,iBAChCoB,MAAQrB,SAASC,eAAe,iBAEtC,IAAII,QAAU,EACXgB,QACChB,QAAUR,WAAWwB,MAAM/B,OAASO,WAAWqB,0BAGhDE,OAASC,OACRhC,gBAAgBgB,QAASd,WAAYC,QAAS2B,uBAE9CE,MAAMC,iBAAiB,UAAU,KAC7BF,MAAM9B,MAAQe,OAAO,IAEzBe,MAAME,iBAAiB,UAAU,KAC7BjB,QAAUe,MAAM9B,MAChB+B,MAAM/B,MAAQ8B,MAAM9B,MACpBD,gBAAgBgB,QAASd,WAAYC,QAAS2B,uBAC9CR,mBAAmBpB,WAAYc,SAC/BD,sBAAsBb,WAAYc,QAAQ,IAE9Ce,MAAME,iBAAiB,SAAS,KAC5BjB,QAAUe,MAAM9B,MAChB+B,MAAM/B,MAAQ8B,MAAM9B,MACpBD,gBAAgBgB,QAASd,WAAYC,QAAS2B,uBAC9CR,mBAAmBpB,WAAYc,SAC/BD,sBAAsBb,WAAYc,QAAQ,KAG9ChB,gBAAgB,EAAGE,WAAYC,QAAS2B,uBAG5CA,sBAAsBG,iBAAiB,SAAS,KAE5C,MAAMC,QAAUvB,SAASwB,cAAc,uBACjCC,cAAgBzB,SAASC,eAAe,iBAE3CI,QAAUb,QAAUD,WACnBkC,cAAcvB,UAAY,iBAI9BiB,sBAAsBrB,UAAUC,IAAI,YAEpCwB,QAAQzB,UAAUC,IAAI,WACtB,EAAA2B,yBAAYX,UAAWC,YAAaC,OAAQ1B,WAAYc,SACnDsB,MAAKC,OACCA,KAAKC,SACJN,QAAQzB,UAAUK,OAAO,UACzBsB,cAAcvB,UAAY,UAC1B4B,OAAOC,SAASC,SAChBC,mBAAUC,iBAAiB,oCAAqC,IAC3DP,MAAKQ,OAAgB,IAAfC,KAACA,KAAIC,GAAEA,IAAGF,KACbF,mBAAUK,oBAAoB,4BAA6BF,KAAMC,GAAG,IAEvEE,OAAOC,QAAU,EAAAC,yBAAiBD,WAEvCf,cAAcvB,UAAY,sDAC1BiB,sBAAsBrB,UAAUK,OAAO,gBAE7C,KAGhB"}